<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP各种特性概览 | haha blog</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/blog/logo.png">
    <meta name="description" content="哈哈的博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.62760db6.css" as="style"><link rel="preload" href="/blog/assets/js/app.2967c561.js" as="script"><link rel="preload" href="/blog/assets/js/2.5c9c2456.js" as="script"><link rel="preload" href="/blog/assets/js/3.af14b7bd.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ea2c9459.js"><link rel="prefetch" href="/blog/assets/js/11.dc5f1251.js"><link rel="prefetch" href="/blog/assets/js/12.d281fb59.js"><link rel="prefetch" href="/blog/assets/js/13.d0ae9b9c.js"><link rel="prefetch" href="/blog/assets/js/14.8977d787.js"><link rel="prefetch" href="/blog/assets/js/15.e52e71ce.js"><link rel="prefetch" href="/blog/assets/js/16.b88cc6d2.js"><link rel="prefetch" href="/blog/assets/js/17.4b8c318a.js"><link rel="prefetch" href="/blog/assets/js/18.8ec919f5.js"><link rel="prefetch" href="/blog/assets/js/19.a4db0c35.js"><link rel="prefetch" href="/blog/assets/js/20.a1faae1d.js"><link rel="prefetch" href="/blog/assets/js/21.f0a8953c.js"><link rel="prefetch" href="/blog/assets/js/22.36083da6.js"><link rel="prefetch" href="/blog/assets/js/23.97561a6e.js"><link rel="prefetch" href="/blog/assets/js/24.b8ea88de.js"><link rel="prefetch" href="/blog/assets/js/25.e8791db8.js"><link rel="prefetch" href="/blog/assets/js/26.dd1deea5.js"><link rel="prefetch" href="/blog/assets/js/27.1527ac15.js"><link rel="prefetch" href="/blog/assets/js/28.593c8b1a.js"><link rel="prefetch" href="/blog/assets/js/4.cba27ac5.js"><link rel="prefetch" href="/blog/assets/js/5.d1ced191.js"><link rel="prefetch" href="/blog/assets/js/6.2dd13b67.js"><link rel="prefetch" href="/blog/assets/js/7.567daa3c.js"><link rel="prefetch" href="/blog/assets/js/8.ed0cdc00.js"><link rel="prefetch" href="/blog/assets/js/9.9ceddb8a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.62760db6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">haha blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">javascript</span> <span class="arrow down"></span></button> <button type="button" aria-label="javascript" class="mobile-dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/javascript/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/blog/react/index/" class="nav-link">
  react
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/http/" class="nav-link router-link-active">
  HTTP 协议
</a></li></ul></div></div> <a href="https://github.com/gaokaifeis/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">javascript</span> <span class="arrow down"></span></button> <button type="button" aria-label="javascript" class="mobile-dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/javascript/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/blog/react/index/" class="nav-link">
  react
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/http/" class="nav-link router-link-active">
  HTTP 协议
</a></li></ul></div></div> <a href="https://github.com/gaokaifeis/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>HTTP协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/http/" aria-current="page" class="sidebar-link">HTTP协议简介</a></li><li><a href="/blog/http/HTTPdevhistory.html" class="sidebar-link">HTTP协议基础及发展历史</a></li><li><a href="/blog/http/HTTPFeatures.html" aria-current="page" class="active sidebar-link">HTTP各种特性概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#认识http客户端" class="sidebar-link">认识HTTP客户端</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#cors跨域请求的限制与解决" class="sidebar-link">CORS跨域请求的限制与解决</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#cors跨域限制以及预请求验证" class="sidebar-link">CORS跨域限制以及预请求验证</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#缓存头cache-control的含义和使用" class="sidebar-link">缓存头Cache-Control的含义和使用</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#缓存验证last-modified和etag的使用" class="sidebar-link">缓存验证Last-Modified和Etag的使用</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#cookie和session" class="sidebar-link">cookie和session</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#http长连接" class="sidebar-link">HTTP长连接</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#数据协商" class="sidebar-link">数据协商</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#redirect" class="sidebar-link">Redirect</a></li><li class="sidebar-sub-header"><a href="/blog/http/HTTPFeatures.html#csp-content-security-policy" class="sidebar-link">CSP （Content-Security-Policy）</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="http各种特性概览"><a href="#http各种特性概览" class="header-anchor">#</a> HTTP各种特性概览</h1> <h2 id="认识http客户端"><a href="#认识http客户端" class="header-anchor">#</a> 认识HTTP客户端</h2> <p>只要实现了发送HTTP请求的报文的工具就为HTTP客户端，最简单的HTTP客户端就是浏览器、curl</p> <h2 id="cors跨域请求的限制与解决"><a href="#cors跨域请求的限制与解决" class="header-anchor">#</a> CORS跨域请求的限制与解决</h2> <p>跨域是浏览器自己内置的功能，进行跨域请求时，浏览器也发送了请求，服务器也返回了请求，只不过是浏览器识别到服务器未设置允许跨域时进行了内部处理而已。</p> <p>解决方式为：</p> <ol><li><p>在响应头里加上<code>Access-Control-Allow-Origin: '*'</code></p></li> <li><p>jsonp方式，因为浏览器允许像 <code>link</code>标签、<code>img</code>标签、 <code>script</code>标签等在标签上写路径内容时时允许跨域的。</p></li> <li><p>代理</p></li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>Access-Control-Allow-Origin: '*'</code> 代表的含义时允许所有的访问请求，这样的设置是不安全的，因为别人的第三方的服务也可以访问到。因此我们可以设定确定的url来进行访问，比如：<code>Access-Control-Allow-Origin: 'http://www.baidu.com'</code>,这个头我们只能设置一个值，如果想实现多个域的话就需要在服务端进行逻辑判断来解决。</p></div> <h2 id="cors跨域限制以及预请求验证"><a href="#cors跨域限制以及预请求验证" class="header-anchor">#</a> CORS跨域限制以及预请求验证</h2> <h3 id="cors的一些限制"><a href="#cors的一些限制" class="header-anchor">#</a> CORS的一些限制</h3> <p>跨域默认允许的:</p> <ul><li><p>方法只有GET，HEAD，POST。其他的方法默认都是不允许的</p></li> <li><p>Content-Type有 <code>text/plain</code>、<code>multipart/form-data</code>， <code>application/x-www-form-urlencoded</code></p></li> <li><p>其他限制</p> <ol><li><p>请求头限制，具体可查看<a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>XMLHttpRequestUpload对象均没有注册任何事件监听器</p></li> <li><p>请求中没有使用ReadableStream对象</p></li></ol></li></ul> <h3 id="cors预请求"><a href="#cors预请求" class="header-anchor">#</a> CORS预请求</h3> <p>如何设置自定义的头允许发送，就需要服务端返回新的头来允许，也就是设置<code>Access-Control-Allow-Header</code>为你规定好的自定义头即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>'http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex">/localhost:8887/</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'X-Test-Cors'</span><span class="token operator">:</span> <span class="token string">'123'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>浏览器执行上面的代码后，会先发送一个OPTION请求，OPTION请求会预先去验证你需要发送的方法是否允许，该方法跨域是否允许。</p> <p>还可以设置允许跨域的方法<code>Access-Control-Allow-Methods</code>,<br>
以逗号分隔即可，如： <code>Access-Control-Allow-Methods='PUT, DELETE'</code></p> <p><code>Access-Control-Max-Age</code>是设置允许请求在验证后多少秒之内不用发起预请求来验证是否可以跨域，例如： <code>Access-Control-Max-Age: '1000'</code></p> <h2 id="缓存头cache-control的含义和使用"><a href="#缓存头cache-control的含义和使用" class="header-anchor">#</a> 缓存头Cache-Control的含义和使用</h2> <ul><li><p>可缓存性</p> <ol><li>public 是指HTTP请求返回的过程中，返回的内容所经过的任何路径中，包括HTTP代理服务器，以及发出请求的客户端浏览器都可以进行缓存。</li> <li>private 只有发起请求的客户端可进行缓存</li> <li>no-cache 所有地方都能缓存，但是都需要向服务器进行验证，如果服务器允许使用本地的缓存客户端就可以使用</li></ol></li> <li><p>到期</p> <ol><li>max-age='seconds'设置过期日期</li> <li>s-maxage='seconds' 会代替max-age, 但是只有在代理服务器中才能生效</li> <li>max-stale='seconds' 设置后哪怕缓存（max-age）已经过期，但是还未超过max-stale的时间，还是可以使用过期的缓存</li></ol></li> <li><p>重新验证</p> <ol><li>must-revalidate 在已经设置max-age,且缓存过期后，必须到源服务端重新发起请求重新获取数据再来验证数据是否真的过期</li> <li>proxy-revalidate 指定缓存服务器在缓存过期后需要重新向源服务器请求一遍</li></ol></li> <li><p>其他</p> <ol><li>no-store 任何地方都不能存储缓存</li> <li>no-transform 不要进行改变数据格式</li></ol></li></ul> <p>服务端例子：</p> <p><code>Cache-Control: 'max-age=20, public'</code></p> <h2 id="缓存验证last-modified和etag的使用"><a href="#缓存验证last-modified和etag的使用" class="header-anchor">#</a> 缓存验证Last-Modified和Etag的使用</h2> <p><img src="/blog/assets/img/cacheVilidate.35eed21a.png" alt="缓存验证"></p> <p>当浏览器设置<code>no-cache</code>后如何进行验证? 主要有两个头设置</p> <ul><li><p>Last-Modified</p> <p>意思就是上次修改时间，主要配合If-Modified-Since或者If-Unmodified-Since使用。对比上次修改时间以验证资源需要更新。</p></li> <li><p>Etag</p> <p>数据签名，对资源进行数据签名，配合If-Match或者If-None-Match使用。对比资源的签名判断是否使用缓存。</p></li></ul> <p>服务端例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/script.js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">const</span> etag <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'if-none-match'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>etag <span class="token operator">===</span> <span class="token string">'777'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">304</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/javascript'</span><span class="token punctuation">,</span>
        <span class="token string">'Cache-Control'</span><span class="token operator">:</span> <span class="token string">'max-age=2000000, no-cache'</span><span class="token punctuation">,</span>
        <span class="token string">'Last-Modified'</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
        <span class="token string">'Etag'</span><span class="token operator">:</span> <span class="token string">'777'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/javascript'</span><span class="token punctuation">,</span>
        <span class="token string">'Cache-Control'</span><span class="token operator">:</span> <span class="token string">'max-age=2000000, no-cache'</span><span class="token punctuation">,</span>
        <span class="token string">'Last-Modified'</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
        <span class="token string">'Etag'</span><span class="token operator">:</span> <span class="token string">'777'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'console.log(&quot;script loaded twice&quot;)'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="cookie和session"><a href="#cookie和session" class="header-anchor">#</a> cookie和session</h2> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> cookie</h3> <p>cookie是通过Set-Cookie进行设置的，下次请求就会自动带上</p> <p>包括的属性：</p> <ul><li><p>max-age和expires设置过期时间</p> <p>max-age是设置多少时间后过期， expires是设置到那个时间点过期</p></li> <li><p>Secure只在https的时候发送</p></li> <li><p>HttpOnly设置后将无法通过document.cookie进行访问</p></li> <li><p>domain 访问域的权限设置</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
      <span class="token string">'Set-Cookie'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'id=123; max-age=2; HttpOnly'</span><span class="token punctuation">,</span>
        <span class="token string">'abc=456;domain=test.com'</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
</code></pre></div><p>HTTP headers并未限制键名只能有一个，因此Set-Cookie是可以多个的，在nodejs中当把Set-Cookie设置为数组时就会有多个Set-Cookie的头进行设置。</p> <p>cookie是有存在时效的，当没有设置过期时间的话，浏览器关掉后就会删除掉。</p> <h3 id="session"><a href="#session" class="header-anchor">#</a> session</h3> <p>session 有很多种实现方法，在网站当中最经常用的是使用 Cookie 来保存 session</p> <h2 id="http长连接"><a href="#http长连接" class="header-anchor">#</a> HTTP长连接</h2> <p>当设置<code>Connection: keep-alive</code>时，chrome最多发起6个TCP连接，当超过次连接数时就会一直等待其他TCP连接空闲出来才能请求。</p> <p>当设置<code>Connection: close</code>时,浏览器请求完成后就会关闭TCP连接，因此所有的请求都会创建新的连接。</p> <h2 id="数据协商"><a href="#数据协商" class="header-anchor">#</a> 数据协商</h2> <p>客户端发送请求给服务端，客户端会声明请求希望拿到的数据的格式和限制，服务端会根据请求头信息，来决定返回的数据</p> <h3 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h3> <ol><li><p>客户端 请求 Accept</p> <ul><li>Accept 声明想要的数据类型</li> <li>Accept-Encoding 数据以哪种编码方式进行传输，限制服务器如何进行数据压缩</li> <li>Accept-Language 展示语言</li> <li>User-Agent 浏览器相关信息，移动端，pc端的浏览器的User-Agent的不同</li></ul></li> <li><p>服务端 返回 Content</p> <ul><li>Content-Type 对应 Accept，从Accept中选择数据类型返回</li> <li>Content-Encoding 对应 Accept-Encoding，声明服务端数据压缩方式</li> <li>Content-Language 对应 Accept-Language，是否根据请求返回语言</li></ul></li></ol> <h3 id="浏览器请求-html-时的头信息"><a href="#浏览器请求-html-时的头信息" class="header-anchor">#</a> 浏览器请求 html 时的头信息</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
</code></pre></div><p>查看 network 的 localhost 文件的请求信息，浏览器会自动加上这些头信息</p> <div class="language- extra-class"><pre class="language-text"><code>Response Headers

Connection: keep-alive
Content-Type: text/html
Date: Fri, 10 Apr 2020 01:32:43 GMT
Transfer-Encoding: chunked

Request Headers

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cache-Control: max-age=0
Connection: keep-alive
Cookie: 
Host: localhost:8888
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</code>: 浏览器可以接收这些格式的数据，可以进行设置</p> <p><code>Accept-Encoding: gzip, deflate, br</code>: 数据编码方式，gzip 使用最多；br 使用比较少，但压缩比高</p> <p><code>Accept-Language: zh-CN,zh;q=0.9</code>: 浏览器会判断本系统的语言，自动加上。q 代表权重，数值越大权重越大，优先级越高</p> <p><code>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36</code>:</p> <ul><li><p>Mozilla/5.0 浏览器最早是网景公司出的，当时默认头是 Mozilla/5.0，很多老的 http 服务器只支持这个头，所以加上兼容老的 web 服务器</p></li> <li><p>AppleWebKit/537.36 浏览器内核 ，chrome 和 safari 等现代浏览器大部分使用 webkit 内核，webkit 内核是苹果公司开发的</p></li> <li><p>KHTML 渲染引擎版本，类似于 Gecko，火狐浏览器渲染引擎</p></li> <li><p>Chrome/80.0.3987.163 chrome 版本号</p></li> <li><p>Safari/537.36 因为使用了 webkit 内核，所以会加上</p></li></ul></div> <h3 id="accept-encoding"><a href="#accept-encoding" class="header-anchor">#</a> Accept-Encoding</h3> <p>数据压缩</p> <p>请求文件大小 933B，使用 gzip 压缩后是 609B</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> zlib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span> <span class="token comment">// 引入包</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span> <span class="token comment">// 这里不加 utf8，加了返回的就是字符串格式了</span>
  response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
    <span class="token comment">// 'X-Content-Options': 'nosniff'</span>
    <span class="token string">'Content-Encoding'</span><span class="token operator">:</span> <span class="token string">'gzip'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">gzipSync</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 压缩</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server listening on 8888'</span><span class="token punctuation">)</span>
</code></pre></div><p>请求文件响应头</p> <div class="language- extra-class"><pre class="language-text"><code>Connection: keep-alive
Content-Encoding: gzip // 返回的压缩算法方式
Content-Type: text/html
Date: Fri, 21 Sep 2018 02:58:54 GMT
Transfer-Encoding: chunked
</code></pre></div><h3 id="content-type"><a href="#content-type" class="header-anchor">#</a> Content-type</h3> <p>用来协商客户端和服务端的数据格式和声明</p> <p>发送请求时，会有不同的请求内容，根据内容不同设置不同的 content-type</p> <p>chorme浏览器设置，勾选 Preserve log，当页面跳转后，也会把之前的请求打印出来</p> <p>发送表单数据</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>application/x-www-form-urlencoded<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>Request Headers
Content-Type: application/x-www-form-urlencoded // content-type 就是 form表单中设置的

Form Data
name=sf&amp;password=sfs
</code></pre></div><p>服务端根据 content-type 是 x-www-form-urlencoded来对body 中的数据进行转化即可</p> <p>如果表单数据中有文件</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span>
    form<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'submit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/form'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> formData
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>multipart/form-data</code>代表请求是有多个部分的，有时通过表单上传文件时，必须要把文件部分单独拆分出来，文件不能作为字符串进行传输的，要作为二进制的数据进行传输；使用 x-www-form-urlencoded 这种拼接字符串的方式 是不对的</p> <div class="language- extra-class"><pre class="language-text"><code>Request Headers
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary39Ug3FSPIBvDYZd6

Request Payload
------WebKitFormBoundary39Ug3FSPIBvDYZd6
Content-Disposition: form-data; name=&quot;name&quot;

sdfs
------WebKitFormBoundary39Ug3FSPIBvDYZd6
Content-Disposition: form-data; name=&quot;password&quot;

sdfs
------WebKitFormBoundary39Ug3FSPIBvDYZd6
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1536973449110.png&quot;
Content-Type: image/png


------WebKitFormBoundary39Ug3FSPIBvDYZd6--
</code></pre></div><p><code>boundary=----WebKitFormBoundary39Ug3FSPIBvDYZd6</code>用来分割表单提交数据的各个部分</p> <p>服务端拿到表单数据后，根据这个分割字符串，进行数据分割</p> <h2 id="redirect"><a href="#redirect" class="header-anchor">#</a> Redirect</h2> <p>通过 url 访问某个路径请求资源时，发现资源不在 url 所指定的位置，这时服务器要告诉浏览器，新的资源地址，浏览器再重新请求新的 url，从而拿到资源。</p> <p>若服务器指定了某个资源的地址，现在需要更换地址，不应该立刻废弃掉 url，如果废弃掉可能直接返回 404，这时应该告诉客户端新的资源地址。</p> <h3 id="redirect-的使用"><a href="#redirect-的使用" class="header-anchor">#</a> Redirect 的使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token comment">// or 301</span>
      <span class="token string">'Location'</span><span class="token operator">:</span> <span class="token string">'/new'</span> <span class="token comment">// 这里是同域跳转，只需要写路由</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;this is content&lt;/div&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server listening on 8888'</span><span class="token punctuation">)</span>
</code></pre></div><p>查看network localhost</p> <p>请求发现是302后，浏览器自动根据响应头中的 Location 路径进行跳转</p> <div class="language-js extra-class"><pre class="language-js"><code>General
Status Code<span class="token operator">:</span> <span class="token number">302</span> <span class="token function">Found</span> <span class="token punctuation">(</span><span class="token keyword">from</span> disk cache<span class="token punctuation">)</span>

Request Headers
Location<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">new</span>
</code></pre></div><h3 id="redirect-301-和-302-的区别"><a href="#redirect-301-和-302-的区别" class="header-anchor">#</a> Redirect 301 和 302 的区别</h3> <p>302 临时跳转，每次请求仍然需要经过服务端指定跳转地址</p> <p>301 永久跳转</p> <p>302的情况</p> <p>每次访问 locahost:8888，都要经过服务端跳转，服务端通过 console.log 可以看到 / /new 两次请求</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  
      <span class="token string">'Location'</span><span class="token operator">:</span> <span class="token string">'/new'</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;this is content&lt;/div&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server listening on 8888'</span><span class="token punctuation">)</span>
</code></pre></div><p>301 的情况</p> <p>访问 locahost:8888，第一次经过服务端跳转，服务端通过 console.log 可以看到 / /new 两次请求；第二次 服务端 console.log 只显示 /new ，没有再次经过服务器指定新的 Location</p> <div class="language-js extra-class"><pre class="language-js"><code>response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">'Location'</span><span class="token operator">:</span> <span class="token string">'/new'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">注意</p> <p>使用 301 要慎重，一旦使用，服务端更改路由设置，用户如果不清理浏览器缓存，就会一直重定向。</p></div> <p>设置了 301，locahost 会从缓存中读取，并且这个缓存会保留到浏览器，当我们访问 8888 都会进行跳转。此时，就算服务端改变设置也是没有用的，浏览器还是会从缓存中读取。</p> <h2 id="csp-content-security-policy"><a href="#csp-content-security-policy" class="header-anchor">#</a> CSP （Content-Security-Policy）</h2> <ul><li>作用
<ol><li>限制资源获取</li> <li>报告资源获取越权</li></ol></li> <li>限制方式
<ol><li>default-scr限制全局</li> <li>指定资源类型</li></ol></li> <li>资源类型
<ol><li>connect-src</li> <li>img-src</li> <li>mainfest-src</li> <li>font-src</li> <li>style-src</li> <li>media-src</li> <li>frame-src</li> <li>script-src</li></ol></li></ul> <h3 id="限制内联脚本"><a href="#限制内联脚本" class="header-anchor">#</a> 限制内联脚本</h3> <p>server</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request come'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'default-src http: https:'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
     response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server listening on 8888'</span><span class="token punctuation">)</span>
</code></pre></div><p>html</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>This is content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'inline js'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后启动服务去访问，会出现如下报错</p> <p><code>Refused to execute inline script because it violates the following Content Security Policy directive: &quot;default-src http: https:&quot;. Either the 'unsafe-inline' keyword, a hash ('sha256-KU4m2rqHAFwi569te1RE5P3qW1O/qJ+m+gVo66Frm4k='), or a nonce ('nonce-...') is required to enable inline execution. Note also that 'script-src' was not explicitly set, so 'default-src' is used as a fallback.</code></p> <p>###　限制外链加载 script</p> <p>限制外链接在 的 script 通过哪些域名进行加载．如，限制只能通过本域名进行加载 外链 script</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'script-src \'self\''</span> <span class="token comment">// 限制外链 script 只能是本域名下的</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// test.html
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>  本域名下的可以使用
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/jquery/3.3.1/core.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>8888端口访问，可以看到报错信息</p> <p><code>Refused to load the script 'https://cdn.bootcss.com/jquery/3.3.1/core.js' because it violates the following Content Security Policy directive: &quot;script-src 'self'&quot;.</code></p> <p>查看 network，发现在浏览器端就被 block掉了，没有发送请求。</p> <p><img src="/blog/assets/img/cspblock.234c3786.png" alt="CSPblock"></p> <h3 id="限制指定某个网站"><a href="#限制指定某个网站" class="header-anchor">#</a> 限制指定某个网站</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'script-src \'self\' https://cdn.bootcss.com'</span> <span class="token comment">// 限制外链 script 只能是本域名下的，允许指定域名script加载</span>
</code></pre></div><p>这样就没有报错信息了，network 看到 core.js加载成功</p> <h3 id="限制-form-表单提交范围"><a href="#限制-form-表单提交范围" class="header-anchor">#</a> 限制 form 表单提交范围</h3> <p>form 不接受 default-src 的限制，可以通过 form-action来限制。</p> <p>下例中 form 会调转到 <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer">baidu.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，通过 form-action限制浏览器会报错。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'script-src \'self\'; form-action \'self\''</span> <span class="token comment">// 限制表单提交只能在本域下</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// test.html
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://baidu.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>报错信息</p> <p><code>Refused to send form data to 'http://baidu.com/' because it violates the following Content Security Policy directive: &quot;form-action 'self'&quot;.</code></p> <h3 id="限制图片链接"><a href="#限制图片链接" class="header-anchor">#</a> 限制图片链接</h3> <p>通过全局限制 default-src 就可以实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'default-src \'self\'; form-action \'self\''</span> 
</code></pre></div><h3 id="限制-ajax-请求"><a href="#限制-ajax-请求" class="header-anchor">#</a> 限制 ajax 请求</h3> <p>通过 connect-src</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'connect-src \'self\'; form-action \'self\'; report-uri / report'</span> 
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"> 
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://baidu.com'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>报错信息</p> <p><code>Refused to connect to 'http://baidu.com/' because it violates the following Content Security Policy directive: &quot;connect-src 'self'&quot;.</code></p> <h3 id="汇报"><a href="#汇报" class="header-anchor">#</a> 汇报</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token string">'Content-Security-Policy'</span><span class="token operator">:</span> <span class="token string">'default-src \'self\'; form-action \'self\'; report-uri / report'</span> 
</code></pre></div><p>network查看，发送的内容，是 标准的 csp report 的内容。</p> <p><img src="/blog/assets/img/cspreport.bb1fc289.png" alt="CSPreport"></p> <h3 id="允许加载但汇报"><a href="#允许加载但汇报" class="header-anchor">#</a> 允许加载但汇报</h3> <p>使用 ‘Content-Security-Policy-Report-Only’</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token string">'Content-Security-Policy-Report-Only'</span><span class="token operator">:</span> <span class="token string">'default-src \'self\'; form-action \'self\'; report-uri / report'</span> 
</code></pre></div><p>资源会正常加载，但是汇报 Report-Only相关的错误提醒</p> <h3 id="在-html-中使用-csp"><a href="#在-html-中使用-csp" class="header-anchor">#</a> 在 html 中使用 csp</h3> <p>和在服务端使用效果相同，最好在服务端做。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Security-Policy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script-src <span class="token punctuation">'</span>self<span class="token punctuation">'</span>; form-action <span class="token punctuation">'</span>self<span class="token punctuation">'</span>;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>report-uri 不允许在 html 的 meta 中使用，只能在服务端通过 head 进行设置。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/gaokaifeis/blog/edit/master/docs/http/HTTPFeatures.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/16/2020, 2:48:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/http/HTTPdevhistory.html" class="prev">
        HTTP协议基础及发展历史
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2967c561.js" defer></script><script src="/blog/assets/js/2.5c9c2456.js" defer></script><script src="/blog/assets/js/3.af14b7bd.js" defer></script>
  </body>
</html>
